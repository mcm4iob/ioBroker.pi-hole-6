# Automatically merge Dependabot PRs for minor and patch updates when all checks pass

name: Auto-Merge Dependabot PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: write

jobs:
  # Ensure branch protection rules are configured
  ensure-branch-protection:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Setup branch protection for main branch
        continue-on-error: true
        run: |
          echo "Setting up branch protection rules..."
          
          # First, try to get existing branch protection
          EXISTING=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/branches/main/protection" \
            2>/dev/null || echo "{}")
          
          # Define required status checks
          REQUIRED_CHECKS='[
            {"context": "check-and-lint", "app_id": -1},
            {"context": "adapter-tests (20.x, ubuntu-latest)", "app_id": -1},
            {"context": "adapter-tests (22.x, ubuntu-latest)", "app_id": -1},
            {"context": "adapter-tests (20.x, windows-latest)", "app_id": -1},
            {"context": "adapter-tests (22.x, windows-latest)", "app_id": -1},
            {"context": "adapter-tests (20.x, macos-latest)", "app_id": -1},
            {"context": "adapter-tests (22.x, macos-latest)", "app_id": -1}
          ]'
          
          # Create protection rules payload
          PAYLOAD=$(cat <<EOF
          {
            "required_status_checks": {
              "strict": false,
              "checks": $REQUIRED_CHECKS
            },
            "enforce_admins": false,
            "required_pull_request_reviews": null,
            "restrictions": null,
            "required_linear_history": false,
            "allow_force_pushes": false,
            "allow_deletions": false,
            "block_creations": false,
            "required_conversation_resolution": false,
            "lock_branch": false,
            "allow_fork_syncing": false
          }
          EOF
          )
          
          # Apply branch protection
          echo "$PAYLOAD" | gh api \
            --method PUT \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/branches/main/protection" \
            --input - || {
              echo "::warning::Failed to set branch protection rules. This requires admin permissions."
              echo "::warning::Please manually configure branch protection in Settings > Branches to require:"
              echo "::warning::  - check-and-lint"
              echo "::warning::  - adapter-tests (all matrix combinations)"
              echo "::warning::Without branch protection, auto-merge may occur before all checks complete."
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  auto-merge:
    needs: ensure-branch-protection
    if: github.actor == 'dependabot[bot]' && (success() || failure())
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Dependabot metadata
        id: dependabot-metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge for minor and patch updates
        if: |
          steps.dependabot-metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.dependabot-metadata.outputs.update-type == 'version-update:semver-minor'
        run: |
          gh pr merge --auto --squash "$PR_URL"
          echo "âœ“ Auto-merge enabled for PR. It will merge automatically once all required checks pass."
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
